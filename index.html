<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>藥品採購查詢系統</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== 防止 iOS 橫向溢出（核心） ===== */
html, body {
  width: 100%;
  max-width: 100%;
  overflow-x: hidden;
}

* {
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

body {
  margin: 0;
  background: #eef1f7;
  min-height: 100vh;
}

/* ===== 主容器 ===== */
.app {
  width: min(1100px, 100%);
  background: #fff;
  margin: 20px auto;
  padding: 24px;
  border-radius: 20px;
  box-shadow: 0 18px 40px rgba(0,0,0,.12);
}

h1 {
  text-align: center;
  margin: 0 0 6px;
}

.subtitle {
  text-align: center;
  color: #6b7280;
  font-size: 14px;
  margin-bottom: 16px;
}

/* ===== 表單 ===== */
.row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

label { font-weight: 800; }

input, select {
  padding: 8px 14px;
  border-radius: 999px;
  border: 1px solid #d1d5db;
  font-size: 14px;
}

button {
  padding: 8px 18px;
  border-radius: 999px;
  border: none;
  background: #4f46e5;
  color: #fff;
  font-weight: 800;
  cursor: pointer;
}

.emergency-btn { background:#dc2626; }

/* ===== 統計 pill ===== */
.pill {
  padding: 4px 12px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 800;
}
.pill-total { background:#dbeafe; color:#1e3a8a; }
.pill-buy { background:#fee2e2; color:#991b1b; }
.pill-ok { background:#dcfce7; color:#166534; }

/* ===== 桌機表格 ===== */
.table-wrap {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th {
  background: #e5e7eb;
  padding: 8px;
  position: sticky;
  top: 0;
}

td {
  padding: 6px 8px;
  vertical-align: middle;
}

tr:nth-child(even) td {
  background: #f3f4f6;
}

td.col-stock input {
  width: 80px;
  text-align: center;
  border-radius: 10px;
}

/* ===== 狀態標籤 ===== */
.tag {
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-weight:800;
  font-size:12px;
}
.tag-empty { background:#e5e7eb; }
.tag-buy { background:#fee2e2; color:#b91c1c; }
.tag-ok { background:#dcfce7; color:#166534; }

/* ===================================================== */
/* ================= 手機卡片版 ========================= */
/* ===================================================== */
@media (max-width: 520px){

  .app {
    width: 100%;
    margin: 0;
    padding: 12px;
    border-radius: 0;
    box-shadow: none;
  }

  h1 { font-size: 26px; }
  .subtitle { font-size: 12px; }

  /* 表格 → 卡片 */
  .table-wrap { overflow: visible; }
  table {
    border-collapse: separate;
    border-spacing: 0 8px;
  }
  thead { display: none; }

  tr {
    display: grid;
    grid-template-columns: 1fr 120px;
    grid-template-areas:
      "code right"
      "drug right"
      "usage right";
    gap: 4px 8px;
    background: #fff;
    border-radius: 14px;
    padding: 10px;
  }

  td {
    padding: 0;
    white-space: normal;
  }

  td.col-code {
    grid-area: code;
    font-weight: 900;
    font-size: 14px;
  }

  td.col-drug {
    grid-area: drug;
    font-weight: 700;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  td.col-usage {
    grid-area: usage;
    font-weight: 800;
    color: #374151;
  }

  /* ===== 右欄（關鍵） ===== */
  td.col-stock {
    grid-area: right;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 6px;

    min-height: 48px;      /* 防止 iOS 壓扁 */
    align-self: stretch;   /* 防止高度 = 0 */
  }

  td.col-status { display:none; }

  td.col-stock input {
    width: 68px;
    min-height: 36px;
    font-size: 16px;       /* iOS 可輸入 */
    text-align: center;
  }

  td.col-stock .tag {
    max-width: 50px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 11px;
    padding: 4px 6px;
  }
}

/* ===== 緊急 modal ===== */
.modal {
  display:none;
  position:fixed;
  inset:0;
  background:radial-gradient(circle at top,#7f1d1d,#000);
  color:#fff;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
</style>
</head>

<body>
<div class="app">
  <h1>藥品採購查詢系統</h1>
  <div class="subtitle">廠商下拉：中文前2碼 → 英文前5碼（中文優先）</div>

  <div class="row">
    <label>廠商：</label>
    <select id="vendorSelect"><option value="">全部</option></select>
  </div>

  <div class="row">
    <label>搜尋：</label>
    <input id="searchInput" style="flex:1" placeholder="輸入就會自動查（藥代 / 藥名 / 廠商）">
  </div>

  <div class="row">
    <button id="resetBtn">重置</button>
    <button id="emergencyBtn" class="emergency-btn">緊急</button>
    <label><input type="checkbox" id="needBuyOnly"> 只顯示需採購</label>
  </div>

  <div class="row">
    <span class="pill pill-total" id="totalCount"></span>
    <span class="pill pill-buy" id="needBuyCount"></span>
    <span class="pill pill-ok" id="okCount"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>藥代</th>
          <th>藥品</th>
          <th>月用量</th>
          <th>庫存</th>
          <th>狀態</th>
        </tr>
      </thead>
      <tbody id="drugBody"></tbody>
    </table>
  </div>

  <canvas id="chart" height="180"></canvas>
</div>

<div id="emergencyModal" class="modal">
  <div style="text-align:center">
    <h1>⚠️ 請洽店長</h1>
    <button onclick="document.getElementById('emergencyModal').style.display='none'">我知道了</button>
  </div>
</div>

<script>
/* iOS 必要 workaround */
document.addEventListener("touchstart", ()=>{}, {passive:true});

(() => {
  let rawData = [];
  let chart;

  const $ = id => document.getElementById(id);

  const vendorKey = v => {
    v = String(v||"");
    return /^[A-Za-z]/.test(v) ? v.slice(0,5).toUpperCase() : v.slice(0,2);
  };

  function makeTag(x){
    if(x.庫存量==null) return '<span class="tag tag-empty">未輸入</span>';
    return x.需採購
      ? '<span class="tag tag-buy">需採購</span>'
      : '<span class="tag tag-ok">足夠</span>';
  }

  function renderStats(list){
    const total = list.length;
    const need = list.filter(x=>x.需採購).length;
    const ok = list.filter(x=>x.庫存量!=null && !x.需採購).length;

    $("totalCount").textContent = `共 ${total} 筆`;
    $("needBuyCount").textContent = `需採購 ${need} 筆`;
    $("okCount").textContent = `庫存足夠 ${ok} 筆`;

    if(chart) chart.destroy();
    chart = new Chart($("chart"),{
      type:"pie",
      data:{labels:["需採購","庫存足夠"],datasets:[{data:[need,ok]}]},
    });
  }

  function render(list){
    $("drugBody").innerHTML = "";
    list.forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-code">${x.藥代}</td>
        <td class="col-drug">${x.藥品}</td>
        <td class="col-usage">${x.月用量}</td>
        <td class="col-stock">
          <input type="number" value="${x.庫存量??""}">
          ${makeTag(x)}
        </td>
        <td class="col-status"></td>
      `;

      const inp = tr.querySelector("input");
      inp.oninput = ()=>{
        x.庫存量 = inp.value==="" ? null : +inp.value;
        x.需採購 = x.庫存量!=null && x.月用量 > x.庫存量;
        tr.querySelector(".tag").outerHTML = makeTag(x);
        renderStats(list);
      };

      $("drugBody").appendChild(tr);
    });
    renderStats(list);
  }

  function filter(){
    const kw = $("searchInput").value.toLowerCase();
    const vSel = $("vendorSelect").value;
    const needOnly = $("needBuyOnly").checked;

    let list = rawData.filter(x=>{
      if(vSel && vendorKey(x.廠商)!==vSel) return false;
      if(!kw) return true;
      return (
        String(x.藥代).toLowerCase().includes(kw) ||
        String(x.藥品).toLowerCase().includes(kw) ||
        String(x.廠商).toLowerCase().includes(kw)
      );
    });

    if(needOnly) list = list.filter(x=>x.需採購);
    render(list);

    const first = $("drugBody").querySelector("tr");
    if(first) first.scrollIntoView({behavior:"smooth"});
  }

  async function load(){
    const r = await fetch("inventory.json");
    rawData = (await r.json()).map(x=>({...x,庫存量:null,需採購:false}));

    [...new Set(rawData.map(x=>vendorKey(x.廠商)))].forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      $("vendorSelect").appendChild(o);
    });

    filter();
  }

  $("searchInput").addEventListener("input", ()=>{
    clearTimeout(window._t);
    window._t = setTimeout(filter, 200);
  });

  $("vendorSelect").onchange = filter;
  $("needBuyOnly").onchange = filter;
  $("resetBtn").onclick = ()=>{
    $("vendorSelect").value="";
    $("searchInput").value="";
    $("needBuyOnly").checked=false;
    filter();
  };
  $("emergencyBtn").onclick = ()=> $("emergencyModal").style.display="flex";

  load();
})();
</script>
</body>
</html>
