<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
html, body { margin:0; padding:0; width:100%; overflow-x:hidden; }
body { background:#eef1f7; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
body.lock { height:100vh; overflow:hidden; }

/* ===== ä¸»ç•«é¢ ===== */
.app{
  max-width:1100px;
  margin:0 auto;
  background:#fff;
  padding:16px;
}

.row{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
button{ padding:8px 16px; border-radius:20px; border:0; font-weight:800; }
button.primary{ background:#4f46e5; color:#fff; }
button.danger{ background:#dc2626; color:#fff; }
button.dark{ background:#111827; color:#fff; }

input,select{ padding:8px 14px; border-radius:20px; border:1px solid #ccc; }

.pill{ padding:4px 10px; border-radius:20px; font-size:13px; font-weight:800; }
.pill.buy{ background:#fee2e2; color:#991b1b; }
.pill.ok{ background:#dcfce7; color:#166534; }

table{ width:100%; border-collapse:collapse; }
th,td{ padding:8px; font-size:14px; }
tr:nth-child(even){ background:#f3f4f6; }

input.stock{ width:70px; font-size:16px; text-align:center; }

/* ===== Safari çœŸåˆ‡é ï¼šéœ€æ¡è³¼é  ===== */
.buy-page{
  display:none;
  min-height:100vh;
  background:#0b1220;
  color:#fff;
  padding:16px;
}
.buy-card{
  background:#111827;
  border-radius:12px;
  padding:12px;
  margin-bottom:10px;
}
.buy-title{ font-size:22px; font-weight:900; }

/* ===== æ‰‹æ©Ÿ ===== */
@media(max-width:600px){
  table thead{ display:none; }
  tr{ display:block; background:#fff; margin-bottom:10px; border-radius:12px; padding:10px; }
  td{ display:block; padding:4px 0; }
}
</style>
</head>

<body>

<!-- ===== ä¸»ç•«é¢ ===== -->
<div id="mainApp" class="app">
  <h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1>

  <div class="row">
    <label><input type="checkbox" id="needBuyOnly"> åªé¡¯ç¤ºéœ€æ¡è³¼ï¼ˆSafari å¯è·³ï¼‰</label>
    <button class="dark" id="openBuyBtn">éœ€æ¡è³¼æ¸…å–®</button>
  </div>

  <div class="row">
    <span class="pill buy" id="buyCount"></span>
    <span class="pill ok" id="okCount"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th>è—¥ä»£</th><th>è—¥å“</th><th>æœˆç”¨é‡</th><th>åº«å­˜</th><th>ç‹€æ…‹</th>
      </tr>
    </thead>
    <tbody id="drugBody"></tbody>
  </table>
</div>

<!-- ===== éœ€æ¡è³¼é ï¼ˆçœŸåˆ‡é ï¼‰ ===== -->
<div id="buyPage" class="buy-page">
  <div class="row">
    <button id="backBtn">â† è¿”å›</button>
    <button id="csvBtn">å­˜ CSV</button>
    <button id="jsonBtn">å­˜ JSON</button>
  </div>
  <div class="buy-title">éœ€æ¡è³¼æ¸…å–®</div>
  <div id="buyList"></div>
</div>

<script>
/* ===== å‡è³‡æ–™ï¼ˆä½ å¯æ› inventory.jsonï¼‰ ===== */
let data = [
  {è—¥ä»£:"A001",è—¥å“:"AMOXICILLIN",æœˆç”¨é‡:100,åº«å­˜:null},
  {è—¥ä»£:"B002",è—¥å“:"PARACETAMOL",æœˆç”¨é‡:80,åº«å­˜:null}
];

const $ = id => document.getElementById(id);

/* ===== ç‹€æ…‹è¨ˆç®— ===== */
function calc(){
  data.forEach(x=>{
    x.éœ€æ¡è³¼ = x.åº«å­˜!=null && x.æœˆç”¨é‡ > x.åº«å­˜;
  });
}

/* ===== ä¸»è¡¨ ===== */
function renderMain(){
  calc();
  $("drugBody").innerHTML="";
  let buy=0, ok=0;

  data.forEach(x=>{
    if($("needBuyOnly").checked && !x.éœ€æ¡è³¼) return;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${x.è—¥ä»£}</td>
      <td>${x.è—¥å“}</td>
      <td>${x.æœˆç”¨é‡}</td>
      <td><input class="stock" type="number" value="${x.åº«å­˜??""}"></td>
      <td>${x.éœ€æ¡è³¼?"éœ€æ¡è³¼":"è¶³å¤ "}</td>
    `;
    tr.querySelector("input").oninput=e=>{
      x.åº«å­˜=e.target.value===""?null:+e.target.value;
      renderMain();
      if(isBuyPage()) openBuySafari();
    };
    $("drugBody").appendChild(tr);

    x.éœ€æ¡è³¼?buy++:ok++;
  });

  $("buyCount").textContent=`éœ€æ¡è³¼ ${buy}`;
  $("okCount").textContent=`è¶³å¤  ${ok}`;
}

/* ===== Safari çœŸåˆ‡é æ ¸å¿ƒ ===== */
function openBuySafari(){
  renderBuy();
  $("mainApp").style.display="none";
  $("buyPage").style.display="block";

  // ğŸ”¥ Safari å¼·åˆ¶é‡ç¹ª
  $("buyPage").style.webkitTransform="translateZ(0)";
  $("buyPage").offsetHeight;
  $("buyPage").style.webkitTransform="";

  document.body.classList.add("lock");
  window.scrollTo(0,0);
}
function closeBuySafari(){
  $("buyPage").style.display="none";
  $("mainApp").style.display="block";
  document.body.classList.remove("lock");
  window.scrollTo(0,0);
}
function isBuyPage(){
  return $("buyPage").style.display==="block";
}

/* ===== éœ€æ¡è³¼å…§å®¹ ===== */
function renderBuy(){
  calc();
  $("buyList").innerHTML="";
  data.filter(x=>x.éœ€æ¡è³¼).forEach(x=>{
    const d=document.createElement("div");
    d.className="buy-card";
    d.innerHTML=`
      <div><b>${x.è—¥ä»£}</b> ${x.è—¥å“}</div>
      <div>æœˆç”¨é‡ï¼š${x.æœˆç”¨é‡}</div>
      <div>åº«å­˜ï¼š${x.åº«å­˜}</div>
      <div>å»ºè­°æ¡è³¼ï¼š${x.æœˆç”¨é‡-x.åº«å­˜}</div>
    `;
    $("buyList").appendChild(d);
  });
}

/* ===== Safari checkbox é›™äº‹ä»¶ ===== */
const cb=$("needBuyOnly");
function toggleNeedBuy(){
  renderMain();
  if(cb.checked) openBuySafari();
  else closeBuySafari();
}
cb.addEventListener("change", toggleNeedBuy);
cb.addEventListener("touchend", ()=>setTimeout(toggleNeedBuy,0));

/* ===== å…¶ä»–æŒ‰éˆ• ===== */
$("openBuyBtn").onclick=()=>{ cb.checked=true; openBuySafari(); };
$("backBtn").onclick=()=>{ cb.checked=false; closeBuySafari(); };

$("csvBtn").onclick=()=>{
  const rows=[["è—¥ä»£","è—¥å“","æœˆç”¨é‡","åº«å­˜","å»ºè­°æ¡è³¼"]];
  data.filter(x=>x.éœ€æ¡è³¼).forEach(x=>{
    rows.push([x.è—¥ä»£,x.è—¥å“,x.æœˆç”¨é‡,x.åº«å­˜,x.æœˆç”¨é‡-x.åº«å­˜]);
  });
  download("needbuy.csv", rows.map(r=>r.join(",")).join("\n"));
};
$("jsonBtn").onclick=()=>{
  download("needbuy.json", JSON.stringify(data.filter(x=>x.éœ€æ¡è³¼),null,2));
};

function download(name,content){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([content]));
  a.download=name;
  a.click();
}

/* ===== init ===== */
renderMain();
</script>

</body>
</html>
