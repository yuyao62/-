<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>藥品採購查詢系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #eef1f7; display: flex; justify-content: center; min-height: 100vh; }
    .app { width: min(1100px, 100%); background: #fff; margin: 20px; padding: 24px; border-radius: 20px; box-shadow: 0 18px 40px rgba(0,0,0,.12); }
    h1 { text-align: center; margin-bottom: 6px; }
    .subtitle { text-align: center; color: #6b7280; font-size: 14px; margin-bottom: 20px; }

    .row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 16px; }
    label { font-weight: 800; }

    input, select {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    button {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      background: #4f46e5;
      color: #fff;
      font-weight: 800;
      cursor: pointer;
    }

    .emergency-btn { background:#dc2626; animation:pulse 1.4s infinite; }
    @keyframes pulse {
      0% { box-shadow:0 0 0 0 rgba(220,38,38,.6); }
      70% { box-shadow:0 0 0 14px rgba(220,38,38,0); }
      100% { box-shadow:0 0 0 0 rgba(220,38,38,0); }
    }

    .pill { padding:4px 12px; border-radius:999px; font-size:13px; font-weight:800; }
    .pill-total { background:#dbeafe; color:#1e3a8a; }
    .pill-buy { background:#fee2e2; color:#991b1b; }
    .pill-ok { background:#dcfce7; color:#166534; }

    /* ✅ 表格外框：手機可滑動（但我們也會縮欄位，盡量同頁看得到庫存） */
    .table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      table-layout: fixed;     /* ✅ 欄寬才可控 */
      min-width: 0;            /* ✅ 不強制變很寬 */
    }
    th{
      background:#e5e7eb;
      padding:8px;
      position:sticky;
      top:0;
      white-space:nowrap;
    }
    td{
      padding:6px 8px;
      white-space:nowrap;
      vertical-align: middle;
    }
    tr:nth-child(even) td { background:#f3f4f6; }

    /* ✅ 欄寬配置（桌機） */
    th.col-code,  td.col-code  { width: 92px; }
    th.col-drug,  td.col-drug  { width: 360px; }
    th.col-usage, td.col-usage { width: 96px; text-align:right; }
    th.col-stock, td.col-stock { width: 110px; text-align:center; }
    th.col-status,td.col-status{ width: 96px; }

    /* ✅ 藥品欄：超出省略 */
    th.col-drug, td.col-drug{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* ✅ 庫存欄固定寬度 + 置中（輸入框不要太大） */
    td.col-stock{ padding:4px; }
    td.col-stock input[type="number"]{
      width:80px;
      text-align:center;
      padding:6px 8px;
      border-radius:10px;
      font-size:13px;
    }

    /* ✅ 狀態顏色（可選） */
    .tag { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; }
    .tag-empty{ background:#e5e7eb; color:#111827; }
    .tag-buy{ background:#fee2e2; color:#b91c1c; }
    .tag-ok{ background:#dcfce7; color:#166534; }

    /* ✅ 手機：更激進縮「藥品」欄，讓庫存能同頁操作 */
    @media (max-width: 480px){
      .app{ margin:12px; padding:16px; }
      th, td{ padding:6px 6px; }

      th.col-code,  td.col-code  { width: 76px; }
      th.col-drug,  td.col-drug  { width: 150px; }  /* ⭐ 你可改 130~180 */
      th.col-usage, td.col-usage { width: 72px; }
      th.col-stock, td.col-stock { width: 92px; }
      th.col-status,td.col-status{ width: 80px; }

      td.col-stock input[type="number"]{ width:58px; padding:6px 6px; font-size:12px; }
    }

    .modal {
      display:none; position:fixed; inset:0;
      background:radial-gradient(circle at top,#7f1d1d,#000);
      color:#fff; justify-content:center; align-items:center;
    }
  </style>
</head>

<body>
<div class="app">
  <h1>藥品採購查詢系統</h1>
  <div class="subtitle">廠商下拉：中文前2碼 → 英文前5碼（中文優先顯示）</div>

  <div class="row">
    <label>廠商：</label>
    <select id="vendorSelect"><option value="">全部</option></select>

    <label>搜尋：</label>
    <div style="position:relative;flex:1">
      <input id="searchInput" style="width:100%" placeholder="藥代 / 藥名">
    </div>

    <button id="searchBtn">查詢</button>
    <button id="resetBtn">重置</button>
    <button id="emergencyBtn" class="emergency-btn">緊急</button>

    <label><input type="checkbox" id="needBuyOnly"> 只顯示需採購</label>
  </div>

  <div class="row">
    <span class="pill pill-total" id="totalCount"></span>
    <span class="pill pill-buy" id="needBuyCount"></span>
    <span class="pill pill-ok" id="okCount"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <!-- ✅ 表格已移除「廠商」 -->
        <tr>
          <th class="col-code">藥代</th>
          <th class="col-drug">藥品</th>
          <th class="col-usage">月用量</th>
          <th class="col-stock">庫存</th>
          <th class="col-status">狀態</th>
        </tr>
      </thead>
      <tbody id="drugBody"></tbody>
    </table>
  </div>

  <canvas id="chart" height="180"></canvas>
</div>

<div id="emergencyModal" class="modal">
  <div style="text-align:center;padding:22px 18px">
    <h1 style="font-size:48px;margin:0 0 14px">⚠️ 請洽店長</h1>
    <button onclick="document.getElementById('emergencyModal').style.display='none'">我知道了</button>
  </div>
</div>

<script>
(() => {
  let rawData = [], viewData = [], chart;

  const $ = id => document.getElementById(id);
  const isEng = s => /^[A-Za-z]/.test(s);

  const vendorKey = v => {
    v = String(v || "").trim();
    return isEng(v) ? v.slice(0,5).toUpperCase() : v.slice(0,2);
  };

  function populateVendors(){
    const keys = [...new Set(rawData.map(x => vendorKey(x.廠商)))].filter(Boolean);
    keys.sort((a,b)=>{
      const ae=/^[A-Z]/.test(a), be=/^[A-Z]/.test(b);
      if(ae!==be) return ae-be; // 中文先
      return a.localeCompare(b);
    });
    $("vendorSelect").innerHTML = '<option value="">全部</option>';
    keys.forEach(k=>{
      const o=document.createElement("option");
      o.value=k;
      o.textContent=/^[A-Z]/.test(k)?`${k}（英文前5碼）`:`${k}（中文前2碼）`;
      $("vendorSelect").appendChild(o);
    });
  }

  function filterData(){
    const vSel = $("vendorSelect").value;
    const kw = $("searchInput").value.trim();
    const needOnly = $("needBuyOnly").checked;

    const k = kw.toLowerCase();

    let base = rawData.filter(x=>{
      if(vSel && vendorKey(x.廠商)!==vSel) return false;
      if(!kw) return true;

      // ✅ 只搜「藥代 / 藥品」
      const code = String(x.藥代 || "").toLowerCase();
      const name = String(x.藥品 || "").toLowerCase();
      return code.includes(k) || name.includes(k);
    });

    viewData = needOnly ? base.filter(x=>x.需採購) : base;
    render(base);
  }

  function setStatusCell(td, x){
    if(x.庫存量 == null){
      td.innerHTML = `<span class="tag tag-empty">未輸入</span>`;
      return;
    }
    if(x.需採購){
      td.innerHTML = `<span class="tag tag-buy">需採購</span>`;
    }else{
      td.innerHTML = `<span class="tag tag-ok">庫存足夠</span>`;
    }
  }

  function moveToNextStockInput(currentInput){
    const inputs = Array.from(document.querySelectorAll('#drugBody input[type="number"]'));
    const idx = inputs.indexOf(currentInput);
    if(idx >= 0 && idx < inputs.length - 1){
      const next = inputs[idx + 1];
      next.focus();
      next.select?.();
      // 讓下一列更容易看到（避免被鍵盤擋住）
      next.scrollIntoView({ block: "center", behavior: "smooth" });
    }else{
      // 最後一筆：收鍵盤（如果是手機）
      currentInput.blur();
    }
  }

  function render(base){
    $("drugBody").innerHTML = "";

    viewData.forEach((x, i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-code">${x.藥代}</td>
        <td class="col-drug" title="${String(x.藥品||"")}">${x.藥品}</td>
        <td class="col-usage">${x.月用量}</td>
        <td class="col-stock"><input type="number" inputmode="numeric" value="${x.庫存量 ?? ""}"></td>
        <td class="col-status"></td>
      `;

      const inp = tr.querySelector('input[type="number"]');
      const statusTd = tr.querySelector(".col-status");

      // 初始狀態
      setStatusCell(statusTd, x);

      // ✅ 輸入更新狀態 + 統計
      inp.addEventListener("input", ()=>{
        x.庫存量 = inp.value === "" ? null : +inp.value;
        x.需採購 = (x.庫存量 != null) && (x.月用量 > x.庫存量);
        setStatusCell(statusTd, x);
        renderStats(base);
      });

      // ✅ Enter / 下一步：跳下一列庫存
      inp.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          moveToNextStockInput(inp);
        }
      });

      // ✅ 有些手機不會送 Enter key（Next/Done），用 change 當補強：輸入完離開也自動跳
      inp.addEventListener("change", ()=>{
        // 只有在有值時才跳（避免空值一直跳）
        if(inp.value !== ""){
          moveToNextStockInput(inp);
        }
      });

      $("drugBody").appendChild(tr);
    });

    renderStats(base);
  }

  function renderStats(base){
    const total = base.length;
    const need = base.filter(x=>x.需採購).length;
    const ok = base.filter(x=>x.庫存量!=null && !x.需採購).length;

    $("totalCount").textContent = `共 ${total} 筆`;
    $("needBuyCount").textContent = `需採購 ${need} 筆`;
    $("okCount").textContent = `庫存足夠 ${ok} 筆`;

    if(chart) chart.destroy();
    chart = new Chart($("chart"),{
      type:"pie",
      data:{ labels:["需採購","庫存足夠"], datasets:[{ data:[need, ok] }] },
    });
  }

  async function load(){
    const r = await fetch("inventory.json");
    rawData = (await r.json()).map(x=>({ ...x, 庫存量:null, 需採購:false }));
    populateVendors();
    filterData();
  }

  $("searchBtn").onclick = filterData;
  $("resetBtn").onclick = ()=>{
    $("vendorSelect").value = "";
    $("searchInput").value = "";
    $("needBuyOnly").checked = false;
    filterData();
  };
  $("vendorSelect").onchange = filterData;
  $("needBuyOnly").onchange = filterData;
  $("searchInput").addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ e.preventDefault(); filterData(); }
  });

  $("emergencyBtn").onclick = ()=> $("emergencyModal").style.display = "flex";

  load();
})();
</script>
</body>
</html>
