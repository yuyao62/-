<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; padding: 0; background: #eef1f7; display: flex; justify-content: center; min-height: 100vh; }
    .app { width: min(1100px, 100%); background: white; margin: 20px; padding: 24px; border-radius: 20px; box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12); }
    h1 { text-align: center; margin-bottom: 6px; }
    .subtitle { text-align: center; color: #6b7280; font-size: 14px; margin-bottom: 20px; }

    .row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 16px; }
    label { font-weight: 600; }

    input, select { padding: 8px 14px; border-radius: 999px; border: 1px solid #d1d5db; font-size: 14px; outline: none; }
    input:focus, select:focus { border-color: #6366f1; box-shadow: 0 0 0 1px rgba(99,102,241,0.4); }

    button { padding: 8px 18px; border-radius: 999px; border: none; background: #4f46e5; color: white; font-weight: 600; cursor: pointer; transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease; }
    button:hover { background: #4338ca; transform: translateY(-1px); box-shadow: 0 8px 18px rgba(15,23,42,0.3); }
    button:active { transform: translateY(0); box-shadow: none; }

    /* ğŸ”´ ç·Šæ€¥æŒ‰éˆ•æ¨£å¼ï¼šåœ“å½¢ + è¼•å¾®é–ƒçˆ */
    .emergency-btn {
      background: #dc2626;
      border-radius: 999px;
      min-width: 70px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 16px;
      box-shadow: 0 0 0 0 rgba(220,38,38,0.6);
      animation: pulse-emergency 1.4s infinite;
      font-weight: 800;
      letter-spacing: 2px;
    }
    .emergency-btn:hover { background: #b91c1c; }

    @keyframes pulse-emergency {
      0% { box-shadow: 0 0 0 0 rgba(220,38,38,0.6); transform: scale(1); }
      70% { box-shadow: 0 0 0 14px rgba(220,38,38,0); transform: scale(1.05); }
      100% { box-shadow: 0 0 0 0 rgba(220,38,38,0); transform: scale(1); }
    }

    .pill { padding: 4px 12px; border-radius: 999px; font-size: 13px; font-weight: 600; }
    .pill-total { background: #dbeafe; color: #1e3a8a; }
    .pill-buy { background: #fee2e2; color: #991b1b; }
    .pill-ok  { background: #dcfce7; color: #166534; }

    .table-wrap { background: #f9fafb; padding: 10px; max-height: 520px; overflow: auto; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #e5e7eb; position: sticky; top: 0; padding: 8px; font-weight: 700; z-index: 5; }
    td { padding: 6px 8px; }
    tr:nth-child(even) td { background: #f3f4f6; }

    .status-tag { padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .status-empty { background: #e5e7eb; color: #374151; }
    .status-buy   { background: #fee2e2; color: #b91c1c; }
    .status-ok    { background: #dcfce7; color: #166534; }

    @media (max-width: 640px) { table { font-size: 12px; } }

    .stock-input { width: 100%; border-radius: 999px; }
    @media (max-width: 640px) {
      .stock-input { font-size: 18px; padding: 10px 16px; height: 44px; }
    }

    /* ğŸ”½ è‡ªå‹•å®Œæˆä¸‹æ‹‰ï¼ˆå®šä½æ–¼æœå°‹æ¡†å®¹å™¨ï¼‰ */
    .autocomplete-box {
      position: absolute;
      left: 0;
      top: calc(100% + 6px);
      width: 100%;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      max-height: 260px;
      overflow-y: auto;
      z-index: 999;
      display: none;
      border: 1px solid #e5e7eb;
    }
    .autocomplete-item {
      padding: 10px 14px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .autocomplete-item:hover { background: #eef2ff; }
    .autocomplete-type { font-size: 12px; font-weight: 800; color: #4338ca; }
    .autocomplete-star { color: #f59e0b; font-weight: 900; }

    /* ===========================
       ğŸ”¥ æ»¿ç‰ˆç·Šæ€¥ç•«é¢ï¼ˆModalï¼‰
    =========================== */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: radial-gradient(circle at top, #7f1d1d 0, #111827 55%, #000 100%);
      color: #f9fafb;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
      animation: popIn 0.25s ease-out;
    }
    .modal-title {
      font-size: clamp(32px, 6vw, 52px);
      font-weight: 900;
      margin-bottom: 16px;
      text-shadow: 0 0 12px rgba(0,0,0,0.8);
      letter-spacing: 4px;
      color: #fecaca;
    }
    .modal-text {
      font-size: clamp(40px, 9vw, 72px);
      font-weight: 900;
      margin-bottom: 30px;
      text-shadow: 0 0 18px rgba(0,0,0,0.9);
      color: #fef2f2;
    }
    .modal-sub { font-size: clamp(16px, 3.2vw, 22px); margin-bottom: 30px; opacity: 0.9; }
    .modal-close {
      padding: 12px 26px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #111827;
      border: none;
      font-size: 18px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 12px 30px rgba(0,0,0,0.45);
    }
    .modal-close:hover { background: #d1d5db; }

    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>

<body>
<div class="app">
  <h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1>
  <div class="subtitle">
    ä¾å» å•†å‰å…©ç¢¼åˆ†é¡ Â· æœå°‹æ¡†è‡ªå‹•åˆ¤æ–·ï¼š
    ä¸­æ–‡å» å•†å‰2ç¢¼ã€è‹±æ–‡å» å•†å‰5ç¢¼ Â· è—¥ä»£å‰5ç¢¼ Â· è—¥ååŒ…å« Â· é»å» å•†å»ºè­°å¯ç›´æ¥æŸ¥è©¢
  </div>

  <div class="row">
    <label>å» å•†ï¼ˆå‰å…©ç¢¼ï¼‰ï¼š</label>
    <select id="vendorSelect">
      <option value="">å…¨éƒ¨</option>
    </select>

    <label>æœå°‹ï¼š</label>

    <!-- âœ… æœå°‹æ¡† + è‡ªå‹•å®Œæˆå®¹å™¨ï¼ˆä¸€å®šè¦ position:relativeï¼‰ -->
    <div style="position:relative; flex: 1; min-width: 260px;">
      <input id="searchInput" type="text" style="width:100%;"
             placeholder="è¼¸å…¥ï¼šè—¥ä»£å‰5ç¢¼ / å» å•†(ä¸­æ–‡2ç¢¼ã€è‹±æ–‡5ç¢¼) / è—¥å">
      <div id="autocompleteBox" class="autocomplete-box"></div>
    </div>

    <button id="searchBtn">æŸ¥è©¢</button>
    <button id="resetBtn">é‡ç½®</button>

    <button id="emergencyBtn" class="emergency-btn">ç·Šæ€¥</button>

    <label style="margin-left:auto;">
      <input type="checkbox" id="needBuyOnly">
      åªé¡¯ç¤ºéœ€æ¡è³¼
    </label>
  </div>

  <div class="row">
    <span class="pill pill-total" id="totalCount">å…± 0 ç­†</span>
    <span class="pill pill-buy" id="needBuyCount">éœ€æ¡è³¼ 0 ç­†</span>
    <span class="pill pill-ok" id="okCount">åº«å­˜è¶³å¤  0 ç­†</span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
      <tr>
        <th>å» å•†</th>
        <th>è—¥ä»£</th>
        <th>è—¥å“åç¨±</th>
        <th>æœˆç”¨é‡</th>
        <th>åº«å­˜é‡ï¼ˆè¼¸å…¥ï¼‰</th>
        <th>ç‹€æ…‹</th>
      </tr>
      </thead>
      <tbody id="drugBody"></tbody>
    </table>
  </div>

  <div style="margin-top:20px;">
    <canvas id="chart" height="180"></canvas>
  </div>
</div>

<div id="emergencyModal" class="modal">
  <div class="modal-content">
    <div class="modal-title">âš ï¸ ç·Šæ€¥é€šçŸ¥</div>
    <div class="modal-text">è«‹æ´½åº—é•·</div>
    <div class="modal-sub">å¦‚æœ‰ç–‘å•æˆ–è—¥å“çŸ­ç¼ºï¼Œè«‹ç«‹å³è¯çµ¡åº—é•·è™•ç†ã€‚</div>
    <button id="closeModal" class="modal-close">æˆ‘çŸ¥é“äº†</button>
  </div>
</div>

<script>
  let rawData = [];
  let viewData = [];
  let chartInstance = null;

  // â­ å¸¸ç”¨å» å•†ï¼ˆè‡ªè¡Œå¡«å…¥å¸¸ç”¨æ¸…å–®ï¼Œæœƒç½®é ‚ï¼‰
  const FAVORITE_VENDORS = [
    "3M HEALTH CARE LIMITED",
    "ä¸­åœ‹åŒ–å­¸è£½è—¥è‚¡ä»½æœ‰é™å…¬å¸",
    "æ°¸ä¿¡è—¥å“å·¥æ¥­è‚¡ä»½æœ‰é™å…¬å¸"
  ];

  const autocompleteBox = document.getElementById("autocompleteBox");
  const searchInput = document.getElementById("searchInput");

  function mergeSameItems(list) {
    const merged = {};
    list.forEach(item => {
      const key = `${item.å» å•†}__${item.è—¥ä»£}__${item.è—¥å“}`;
      if (!merged[key]) {
        merged[key] = { ...item };
        merged[key].æœˆç”¨é‡ = Number(item.æœˆç”¨é‡) || 0;
      } else {
        merged[key].æœˆç”¨é‡ += Number(item.æœˆç”¨é‡) || 0;
      }
    });
    return Object.values(merged);
  }

  /* å» å•†å‰å…©ç¢¼ï¼ˆä¸‹æ‹‰ç”¨ï¼Œçµ±ä¸€å¤§å¯«é¿å…é‡è¤‡ï¼‰ */
  function vendorPrefix(name) {
    return String(name ?? "").trim().slice(0, 2).toUpperCase();
  }

  /* è—¥ä»£ï¼šå‰ 5 ç¢¼ */
  function matchDrugCodePrefix5(drugCode, keyword) {
    if (!keyword) return true;
    const code = String(drugCode ?? "").trim().toUpperCase();
    const key  = String(keyword ?? "").trim().toUpperCase().slice(0, 5);
    return code.startsWith(key);
  }

  /* âœ… å» å•†æœå°‹ï¼šä¸­æ–‡å‰2ç¢¼ / è‹±æ–‡å‰5ç¢¼ */
  function matchVendorSmart(vendorName, keyword) {
    if (!keyword) return false;

    const vendor = String(vendorName ?? "").trim();
    const key = String(keyword ?? "").trim();

    const hasChinese = /[\u4e00-\u9fff]/.test(key);

    if (hasChinese) {
      return vendor.startsWith(key.slice(0, 2));
    } else {
      return vendor.toUpperCase().startsWith(key.toUpperCase().slice(0, 5));
    }
  }

  function getUniqueVendors() {
    return [...new Set(rawData.map(x => x.å» å•†))];
  }

  function showVendorAutocomplete(keyword) {
    autocompleteBox.innerHTML = "";

    if (!keyword) {
      autocompleteBox.style.display = "none";
      return;
    }

    let vendors = getUniqueVendors().filter(v => matchVendorSmart(v, keyword));

    // â­ å¸¸ç”¨å» å•†ç½®é ‚
    vendors.sort((a, b) => {
      const aFav = FAVORITE_VENDORS.includes(a);
      const bFav = FAVORITE_VENDORS.includes(b);
      return (bFav === true) - (aFav === true);
    });

    vendors = vendors.slice(0, 12);

    if (vendors.length === 0) {
      autocompleteBox.style.display = "none";
      return;
    }

    vendors.forEach(vendor => {
      const div = document.createElement("div");
      div.className = "autocomplete-item";

      const isFav = FAVORITE_VENDORS.includes(vendor);

      div.innerHTML = `
        <span class="autocomplete-type">ã€å» å•†ã€‘</span>
        ${isFav ? '<span class="autocomplete-star">â­</span>' : ''}
        <span>${vendor}</span>
      `;

      div.addEventListener("click", () => {
        searchInput.value = vendor;
        autocompleteBox.style.display = "none";
        applyFilter(); // é»äº†å°±æŸ¥
      });

      autocompleteBox.appendChild(div);
    });

    autocompleteBox.style.display = "block";
  }

  async function loadData() {
    try {
      const resp = await fetch("inventory.json");
      const data = await resp.json();

      const mapped = data.map((x, idx) => ({
        id: idx,
        å» å•†: x["å» å•†"],
        è—¥ä»£: x["è—¥ä»£"],
        è—¥å“: x["è—¥å“"],
        æœˆç”¨é‡: Number(x["æœˆç”¨é‡"]),
        åº«å­˜é‡: null,
        éœ€æ¡è³¼: false
      }));

      rawData = mergeSameItems(mapped);

      populateVendors();
      applyFilter();
    } catch (err) {
      alert("è®€å– inventory.json å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆå­˜åœ¨ä¸” JSON æ ¼å¼æ­£ç¢ºï¼");
      console.error(err);
    }
  }

  function populateVendors() {
    const sel = document.getElementById("vendorSelect");
    const set = new Set(rawData.map(item => vendorPrefix(item.å» å•†)));

    sel.innerHTML = '<option value="">å…¨éƒ¨</option>';

    [...set].sort().forEach(prefix => {
      const opt = document.createElement("option");
      opt.value = prefix;
      opt.textContent = prefix + "ï¼ˆå‰å…©ç¢¼ï¼‰";
      sel.appendChild(opt);
    });
  }

  function applyFilter() {
    const vendor = document.getElementById("vendorSelect").value;
    const keywordRaw = searchInput.value.trim();
    const keywordLower = keywordRaw.toLowerCase();
    const needOnly = document.getElementById("needBuyOnly").checked;

    const baseData = rawData.filter(item => {
      const matchVendorDrop = vendor ? vendorPrefix(item.å» å•†) === vendor : true;

      const drugName = String(item.è—¥å“ || "").toLowerCase();

      const matchKeyword = keywordRaw
        ? (
            matchDrugCodePrefix5(item.è—¥ä»£, keywordRaw) ||   // è—¥ä»£å‰5ç¢¼
            matchVendorSmart(item.å» å•†, keywordRaw) ||       // å» å•†ä¸­2/è‹±5
            drugName.includes(keywordLower)                   // è—¥ååŒ…å«
          )
        : true;

      return matchVendorDrop && matchKeyword;
    });

    viewData = needOnly ? baseData.filter(item => item.éœ€æ¡è³¼) : baseData;

    renderTable();
    updateStats(baseData);
  }

  function renderTable() {
    const tbody = document.getElementById("drugBody");
    tbody.innerHTML = "";

    viewData.forEach(item => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${item.å» å•†}</td>
        <td>${item.è—¥ä»£}</td>
        <td>${item.è—¥å“}</td>
        <td>${item.æœˆç”¨é‡}</td>
        <td><input type="number" min="0" class="stock-input" value="${item.åº«å­˜é‡ ?? ""}" placeholder="è¼¸å…¥"></td>
        <td class="status-cell"></td>
      `;

      const input = tr.querySelector("input");
      input.addEventListener("input", () => {
        const v = input.value === "" ? null : Number(input.value);
        item.åº«å­˜é‡ = v;
        item.éœ€æ¡è³¼ = (v != null) && (item.æœˆç”¨é‡ > v);
        updateRowStatus(tr, item);
        updateStatsByCurrentFilter();
      });

      tbody.appendChild(tr);
      updateRowStatus(tr, item);
    });
  }

  function updateRowStatus(tr, item) {
    const td = tr.querySelector(".status-cell");

    if (item.åº«å­˜é‡ == null) {
      td.innerHTML = '<span class="status-tag status-empty">æœªè¼¸å…¥</span>';
    } else if (item.éœ€æ¡è³¼) {
      td.innerHTML = '<span class="status-tag status-buy">éœ€æ¡è³¼</span>';
    } else {
      td.innerHTML = '<span class="status-tag status-ok">åº«å­˜è¶³å¤ </span>';
    }
  }

  function updateStatsByCurrentFilter() {
    const vendor = document.getElementById("vendorSelect").value;
    const keywordRaw = searchInput.value.trim();
    const keywordLower = keywordRaw.toLowerCase();

    const baseData = rawData.filter(item => {
      const matchVendorDrop = vendor ? vendorPrefix(item.å» å•†) === vendor : true;

      const drugName = String(item.è—¥å“ || "").toLowerCase();

      const matchKeyword = keywordRaw
        ? (
            matchDrugCodePrefix5(item.è—¥ä»£, keywordRaw) ||
            matchVendorSmart(item.å» å•†, keywordRaw) ||
            drugName.includes(keywordLower)
          )
        : true;

      return matchVendorDrop && matchKeyword;
    });

    updateStats(baseData);
  }

  function updateStats(baseData) {
    const total = baseData.length;
    const need  = baseData.filter(x => x.åº«å­˜é‡ != null && x.éœ€æ¡è³¼).length;
    const ok    = baseData.filter(x => x.åº«å­˜é‡ != null && !x.éœ€æ¡è³¼).length;

    document.getElementById("totalCount").textContent   = `å…± ${total} ç­†`;
    document.getElementById("needBuyCount").textContent = `éœ€æ¡è³¼ ${need} ç­†`;
    document.getElementById("okCount").textContent      = `åº«å­˜è¶³å¤  ${ok} ç­†`;

    const ctx = document.getElementById("chart").getContext("2d");
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["éœ€æ¡è³¼", "åº«å­˜è¶³å¤ "],
        datasets: [{
          data: [need, ok],
          backgroundColor: ["#ef4444", "#10b981"]
        }]
      },
      options: { plugins: { legend: { position: "bottom" } } }
    });
  }

  /* äº‹ä»¶ç¶å®š */
  document.getElementById("searchBtn").addEventListener("click", applyFilter);
  document.getElementById("resetBtn").addEventListener("click", () => {
    document.getElementById("vendorSelect").value = "";
    searchInput.value = "";
    document.getElementById("needBuyOnly").checked = false;
    autocompleteBox.style.display = "none";
    applyFilter();
  });
  document.getElementById("vendorSelect").addEventListener("change", applyFilter);

  // Enter æŸ¥è©¢ + Input é¡¯ç¤ºè‡ªå‹•å®Œæˆ
  searchInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      autocompleteBox.style.display = "none";
      applyFilter();
    }
  });
  searchInput.addEventListener("input", () => {
    showVendorAutocomplete(searchInput.value.trim());
  });

  // é»ç©ºç™½é—œé–‰è‡ªå‹•å®Œæˆ
  document.addEventListener("click", e => {
    if (!autocompleteBox.contains(e.target) && e.target !== searchInput) {
      autocompleteBox.style.display = "none";
    }
  });

  document.getElementById("needBuyOnly").addEventListener("change", applyFilter);

  // ğŸ”´ ç·Šæ€¥æŒ‰éˆ•
  document.getElementById("emergencyBtn").addEventListener("click", () => {
    document.getElementById("emergencyModal").style.display = "flex";
  });
  document.getElementById("closeModal").addEventListener("click", () => {
    document.getElementById("emergencyModal").style.display = "none";
  });
  document.getElementById("emergencyModal").addEventListener("click", (e) => {
    if (e.target.id === "emergencyModal") {
      document.getElementById("emergencyModal").style.display = "none";
    }
  });

  loadData();
</script>

</body>
</html>
