<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>盤點查詢器</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>盤點查詢器</h1>

  <!-- 廠商選擇 -->
  <div class="vendor-section">
    <label for="vendorSelect">輸入或選擇廠商：</label>
    <select id="vendorSelect">
      <option value="">請選擇</option>
    </select>
  </div>

  <!-- 查詢區 -->
  <div class="search-section">
    <label for="searchInput">輸入藥品名稱或代碼：</label>
    <input type="text" id="searchInput" placeholder="輸入後按 Enter 或『查詢』">
    <button onclick="searchDrug()">查詢</button>
    <button onclick="resetSearch()">重置</button>
  </div>

  <!-- 篩選區 -->
  <div class="filter-section">
    <label for="dateSelect">盤點日期：</label>
    <select id="dateSelect">
      <option value="2025-12-11">2025/12/11</option>
    </select>

    <label>
      <input type="checkbox" id="outOfStockFilter"> 只顯示缺貨品項
    </label>
  </div>

  <!-- 查詢結果 -->
  <div id="resultSection">
    <h2>查詢結果</h2>
    <table id="resultTable">
      <thead>
        <tr>
          <th>廠商</th>
          <th>藥品代碼</th>
          <th>藥品名稱</th>
          <th>盤點數量</th>
          <th>狀態</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 統計摘要 -->
  <div id="statsSection">
    <h2>統計摘要</h2>
    <p>總盤點藥品數：<span id="totalCount">0</span></p>
    <p>缺貨品項數：<span id="outOfStockCount">0</span></p>
    <p>缺貨比例：<span id="outOfStockRate">0%</span></p>
    <canvas id="chart" width="400" height="400"></canvas>
  </div>

  <script>
    let inventoryData = [];
    let chartInstance = null;

    // 請確認 JSON 檔案名稱正確，放在同一資料夾
    fetch("合併後的.json")
      .then(response => {
        if (!response.ok) throw new Error("找不到 JSON 檔案");
        return response.json();
      })
      .then(data => {
        if (!Array.isArray(data)) throw new Error("JSON 格式錯誤，必須是陣列");
        inventoryData = data;
        console.log("載入成功:", data);
        populateVendorOptions();
        searchDrug();
      })
      .catch(error => console.error("載入 JSON 失敗:", error));

    function populateVendorOptions() {
      const vendorSet = new Set();
      inventoryData.forEach(item => {
        const vendor = item["廠商"] || item["vendor"];
        if (vendor) vendorSet.add(vendor);
      });

      const vendorSelect = document.getElementById("vendorSelect");
      vendorSet.forEach(vendor => {
        const option = document.createElement("option");
        option.value = vendor;
        option.textContent = vendor;
        vendorSelect.appendChild(option);
      });
    }

    function searchDrug() {
      const keyword = document.getElementById("searchInput").value.trim();
      const selectedVendor = document.getElementById("vendorSelect").value;
      const outOfStockOnly = document.getElementById("outOfStockFilter").checked;
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";

      const results = inventoryData.filter(item => {
        const code = item["藥品代碼"] || item["code"] || "";
        const name = item["藥品名稱"] || item["name"] || "";
        const vendor = item["廠商"] || item["vendor"] || "";
        const qty = item["盤點數量"] || item["qty"] || 0;

        const matchVendor = selectedVendor ? vendor === selectedVendor : true;
        const matchKeyword = keyword ? (code.includes(keyword) || name.includes(keyword)) : true;
        const stockFilter = outOfStockOnly ? qty === 0 : true;

        return matchVendor && matchKeyword && stockFilter;
      });

      results.forEach(item => {
        const vendor = item["廠商"] || item["vendor"] || "";
        const code = item["藥品代碼"] || item["code"] || "";
        const name = item["藥品名稱"] || item["name"] || "";
        const qty = item["盤點數量"] || item["qty"] || 0;

        const row = `<tr>
          <td>${vendor}</td>
          <td>${code}</td>
          <td>${name}</td>
          <td>${qty}</td>
          <td>${qty === 0 ? "缺貨" : "有庫存"}</td>
        </tr>`;
        tbody.innerHTML += row;
      });

      updateStats(results);
    }

    function resetSearch() {
      document.getElementById("searchInput").value = "";
      document.getElementById("vendorSelect").value = "";
      document.getElementById("outOfStockFilter").checked = false;
      searchDrug();
    }

    function updateStats(results) {
      const total = results.length;
      const outOfStock = results.filter(item => {
        const qty = item["盤點數量"] || item["qty"] || 0;
        return qty === 0;
      }).length;
      const rate = total > 0 ? Math.round((outOfStock / total) * 100) : 0;

      document.getElementById("totalCount").textContent = total;
      document.getElementById("outOfStockCount").textContent = outOfStock;
      document.getElementById("outOfStockRate").textContent = rate + "%";

      drawChart(total, outOfStock);
    }

    function drawChart(total, outOfStock) {
      const ctx = document.getElementById("chart").getContext("2d");

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["有庫存", "缺貨"],
          datasets: [{
            data: [total - outOfStock, outOfStock],
            backgroundColor: ["#2ecc71", "#e74c3c"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            title: { display: true, text: "缺貨比例" }
          }
        }
      });
    }
  </script>
</body>
</html>
