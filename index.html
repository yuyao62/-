<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</title>
<style>
html,body{max-width:100%;overflow-x:hidden;margin:0;padding:0;font:16px/1.4 system-ui;background:#f3f4f6;color:#111827}
*{box-sizing:border-box;max-width:100%}
.app{width:min(1100px,100%);margin:12px auto;background:#fff;padding:14px;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.12)}
h1{margin:0 0 6px;text-align:center}.sub{color:#6b7280;text-align:center;font-size:13px;margin-bottom:10px}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0}
label{font-weight:900}
input,select,button{font-size:16px;padding:8px 12px;border-radius:999px;border:1px solid #d1d5db}
button{border:none;cursor:pointer;font-weight:900;background:#4f46e5;color:#fff}
.b2{background:#111827}.b3{background:#e5e7eb;color:#111827}.b4{background:#374151}
.pill{padding:4px 12px;border-radius:999px;font-size:13px;font-weight:900}
.p1{background:#dbeafe}.p2{background:#fee2e2;color:#991b1b}.p3{background:#dcfce7;color:#166534}.p4{background:#ede9fe;color:#4c1d95}
#notice{display:none;margin:10px 0;padding:10px 12px;border-radius:12px;background:#ede9fe;color:#4c1d95;font-weight:900;cursor:pointer}
.table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{padding:8px;vertical-align:top;word-break:break-word}th{background:#e5e7eb}tr:nth-child(even) td{background:#f3f4f6}
.tag{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:900;font-size:13px}
.t0{background:#e5e7eb}.t1{background:#dcfce7;color:#166534}.t2{background:#fee2e2;color:#991b1b}.t3{background:#ede9fe;color:#5b21b6}
.stock{display:flex;flex-direction:column;gap:6px}.top{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.note{width:100%;padding:6px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:14px}
.nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:6px 0 10px}
.view{display:none}.view.on{display:block}
@media (max-width:520px){
.app{margin:0;border-radius:0;box-shadow:none}
table,thead,tbody,tr,td,th{display:block;width:100%}thead{display:none}
tr{background:#fff;border-radius:14px;padding:10px;margin:10px 0}td{padding:4px 0}
td::before{display:block;font-weight:900;color:#6b7280;margin-bottom:2px}
td:nth-child(1)::before{content:"è—¥ä»£"}td:nth-child(2)::before{content:"è—¥å“"}
td:nth-child(3)::before{content:"ç”¨é‡"}td:nth-child(4)::before{content:"åº«å­˜"}td:nth-child(5)::before{content:"å» å•†"}
}
</style></head><body><div class="app">
<h1>è—¥å“æ¡è³¼æŸ¥è©¢ç³»çµ±</h1><div class="sub">å–®æœˆç‚ºä¸»ï½œâ˜‘ é€²éšæ¨¡å¼å¯é¸å¤šæœˆï½œinventory_YYYY_MM.json</div>

<div class="nav">
<button class="b2" id="goMain">æŸ¥è©¢</button>
<button class="b4" id="goYear">å¹´åº¦ç¸½è¦½</button>
<button class="b4" id="goVendor">å» å•†é </button>
<button class="b3" id="exportBtn">åŒ¯å‡º Excel</button>
</div>

<div id="notice" title="é»ä¸€ä¸‹é–‹å•Ÿï¼šå…¬å‘Šæ¸…å–®/å» å•†é "></div>

<!-- ===== æŸ¥è©¢é  ===== -->
<div id="vMain" class="view on">
<div class="row">
<label>å¹´ä»½</label><select id="year"></select>
<label>æœˆä»½</label><button class="b4" id="pm">â—€</button><select id="m1"></select><button class="b4" id="nm">â–¶</button>
<label style="margin-left:6px"><input type="checkbox" id="adv"/> é€²éšæ¨¡å¼</label>
<span id="advBox" style="display:none">
<label>åˆ°</label><select id="m2"></select>
</span>
<button class="b2" id="reload">é‡æ–°è¼‰å…¥</button><button class="b3" id="reset">é‡ç½®</button>
</div>

<div class="row">
<label>å» å•†</label>
<input id="vendorQ" placeholder="è¼¸å…¥å» å•†(å¯æ¨¡ç³Š)" list="vendorList" style="min-width:220px">
<datalist id="vendorList"></datalist>
<button id="vendorClear" class="b3">æ¸…é™¤</button>
</div>

<div class="row">
<label>è—¥ä»£</label><input id="codeQ" placeholder="ä¾‹å¦‚ A123" style="min-width:160px">
<label>è—¥å“</label><input id="nameQ" placeholder="ä¾‹å¦‚ Amoxicillin" style="min-width:220px">
<button id="search">æœå°‹</button><button id="clear" class="b3">æ¸…ç©º</button>
</div>

<div class="row">
<span class="pill p1" id="cAll"></span>
<span class="pill p2" id="cBuy"></span>
<span class="pill p3" id="cOk"></span>
<span class="pill p4" id="cAnn"></span>
</div>

<table class="table">
<thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡</th><th>åº«å­˜</th><th>å» å•†</th></tr></thead>
<tbody id="tb"></tbody>
</table>
</div>

<!-- ===== å¹´åº¦ç¸½è¦½ ===== -->
<div id="vYear" class="view">
<div class="row">
<label>å¹´ä»½</label><select id="year2"></select>
<button class="b2" id="loadYear">è¼‰å…¥å¹´åº¦ç¸½è¦½</button>
<span class="pill p1" id="yInfo"></span>
</div>
<table class="table">
<thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>å¹´åº¦ç”¨é‡</th><th>åº«å­˜</th><th>å» å•†</th></tr></thead>
<tbody id="yTb"></tbody>
</table>
</div>

<!-- ===== å» å•†é  ===== -->
<div id="vVendor" class="view">
<div class="row">
<label>å» å•†</label><input id="vendorPick" placeholder="è¼¸å…¥/é¸æ“‡å» å•†" list="vendorList2" style="min-width:240px">
<datalist id="vendorList2"></datalist>
<button class="b2" id="openVendor">é–‹å•Ÿ</button>
</div>
<table class="table">
<thead><tr><th>è—¥ä»£</th><th>è—¥å“</th><th>ç”¨é‡(ç›®å‰é¸æ“‡)</th><th>åº«å­˜</th><th>å» å•†</th></tr></thead>
<tbody id="vTb"></tbody>
</table>
</div>

</div>

<script>
(()=>{const $=id=>document.getElementById(id);
let data=[], vendors=[], lastFiltered=[], lastView="vMain";
const STOCK="drug_stock_v1", MAN="manual_over_v1", NOTE="drug_note_v1";
const stock=JSON.parse(localStorage.getItem(STOCK)||"{}");
const manual=JSON.parse(localStorage.getItem(MAN)||"{}");
const notes=JSON.parse(localStorage.getItem(NOTE)||"{}");

const isCJK=c=>/[\u4E00-\u9FFF]/.test(c||"");
const normVendor=s=>{
  s=(s||"").trim(); if(!s) return "";
  const a=s[0],b=s[1]; if(isCJK(a)&&isCJK(b)) return s.slice(0,2);
  return s.slice(0,2);
};
const file=(y,m)=>`inventory_${y}_${String(m).padStart(2,"0")}.json`;

function setView(id){["vMain","vYear","vVendor"].forEach(v=>$(v).classList.toggle("on",v===id)); lastView=id;}
$("goMain").onclick=()=>setView("vMain");
$("goYear").onclick=()=>setView("vYear");
$("goVendor").onclick=()=>setView("vVendor");

function init(){
  const y=new Date().getFullYear();
  [$("year"),$("year2")].forEach(sel=>{sel.innerHTML=""; sel.appendChild(new Option(y,y));});
  for(let i=1;i<=12;i++){ $("m1").appendChild(new Option(i,i)); $("m2").appendChild(new Option(i,i)); }
  const m=new Date().getMonth()+1; $("m1").value=m; $("m2").value=m;
  $("adv").onchange=()=>{ $("advBox").style.display=$("adv").checked?"inline-flex":"none"; load(); };
  $("m1").onchange=load; $("m2").onchange=load; $("year").onchange=load;
  $("pm").onclick=()=>shift(-1); $("nm").onclick=()=>shift(1);
  $("reload").onclick=load;
  $("reset").onclick=()=>{[STOCK,MAN,NOTE].forEach(k=>localStorage.removeItem(k)); location.reload();};
  $("search").onclick=applyFilters;
  $("clear").onclick=()=>{$("codeQ").value="";$("nameQ").value="";applyFilters();};
  $("vendorClear").onclick=()=>{$("vendorQ").value="";applyFilters();};
  $("vendorQ").oninput=applyFilters;
  $("codeQ").oninput=applyFilters; $("nameQ").oninput=applyFilters;

  $("loadYear").onclick=loadYear;
  $("openVendor").onclick=()=>renderVendorPage($("vendorPick").value.trim());

  $("exportBtn").onclick=exportExcelLike;
  $("notice").onclick=()=>{ setView("vVendor"); $("vendorPick").focus(); };
  load();
}

function shift(d){
  let m=+$("m1").value; m=Math.min(12,Math.max(1,m+d)); $("m1").value=m;
  if(!$("adv").checked) $("m2").value=m;
  load();
}

async function load(){
  data=[]; vendors=[];
  const y=$("year").value, s=+$("m1").value, e=$("adv").checked?+$("m2").value:s;
  const a=Math.min(s,e), b=Math.max(s,e);
  for(let m=a;m<=b;m++){
    try{
      const r=await fetch(file(y,m),{cache:"no-store"}); if(!r.ok) continue;
      const rows=await r.json();
      rows.forEach(x=>{
        const code=x["è—¥ä»£"], name=x["è—¥å“"], use=Number(x["æœˆç”¨é‡"]||0);
        const vRaw=(x["å» å•†"]||x["ä¾›æ‡‰å•†"]||x["è—¥å•†"]||"").trim();
        const vend=normVendor(vRaw) || normVendor(name) || ""; // æ²’å» å•†æ¬„æ™‚ï¼šé€€ä¸€æ­¥ç”¨è—¥å“å‰å…©ç¢¼ï¼ˆä½ å¯æ”¹ï¼‰
        let rec=data.find(r=>r.è—¥ä»£===code);
        if(!rec){ rec={è—¥ä»£:code,è—¥å“:name,å» å•†:vend,ç”¨é‡:0}; data.push(rec); }
        rec.ç”¨é‡+=use;
        if(vend && !vendors.includes(vend)) vendors.push(vend);
      });
    }catch{}
  }
  vendors.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
  fillVendorLists();
  applyFilters();
  renderVendorPage($("vendorPick").value.trim(), true);
}

function fillVendorLists(){
  const dl1=$("vendorList"), dl2=$("vendorList2");
  dl1.innerHTML=dl2.innerHTML="";
  vendors.forEach(v=>{ dl1.appendChild(new Option(v,v)); dl2.appendChild(new Option(v,v)); });
}

function usage(x){ return Number(x.ç”¨é‡||0); }
function isAnn(x){
  if(manual[x.è—¥ä»£]) return true;
  const u=usage(x), st=stock[x.è—¥ä»£];
  return u>0 && st!=null && st>u*6;
}
function tag(st,u,ann){
  if(ann) return `<span class="tag t3">å…¬å‘Š</span>`;
  if(st==null) return `<span class="tag t0">æœªè¼¸å…¥</span>`;
  if(u>0 && st<u) return `<span class="tag t2">éœ€æ¡è³¼</span>`;
  return `<span class="tag t1">æ­£å¸¸</span>`;
}

function applyFilters(){
  const vq=$("vendorQ").value.trim();
  const cq=$("codeQ").value.trim();
  const nq=$("nameQ").value.trim();
  lastFiltered=data.filter(x=>
    (!vq || x.å» å•†.includes(vq)) &&
    (!cq || String(x.è—¥ä»£).includes(cq)) &&
    (!nq || String(x.è—¥å“).includes(nq))
  );
  renderMain(lastFiltered);
}

function renderMain(list){
  const tb=$("tb"); tb.innerHTML="";
  let ann=0,buy=0,ok=0;
  list.forEach(x=>{
    const u=usage(x), st=stock[x.è—¥ä»£], annF=isAnn(x);
    if(annF) ann++;
    if(st!=null && u>st) buy++; else if(st!=null) ok++;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${x.è—¥ä»£||""}</td>
      <td>${x.è—¥å“||""}</td>
      <td>${u}</td>
      <td><div class="stock"><div class="top">
        <input type="number" inputmode="numeric" value="${st??""}">
        ${tag(st,u,annF)}
      </div><input class="note" placeholder="å‚™è¨»" value="${notes[x.è—¥ä»£]??""}"></div></td>
      <td>${x.å» å•†||""}</td>`;
    const [inp,ninp]=tr.querySelectorAll("input");
    inp.oninput=()=>{ stock[x.è—¥ä»£]=inp.value===""?null:+inp.value; localStorage.setItem(STOCK,JSON.stringify(stock)); renderMain(list); };
    ninp.oninput=()=>{ notes[x.è—¥ä»£]=ninp.value; localStorage.setItem(NOTE,JSON.stringify(notes)); };
    tb.appendChild(tr);
  });
  $("cAll").textContent=`å…± ${list.length}`;
  $("cBuy").textContent=`éœ€æ¡è³¼ ${buy}`;
  $("cOk").textContent=`æ­£å¸¸ ${ok}`;
  $("cAnn").textContent=`å…¬å‘Š ${ann}`;

  // âœ… å…¨éƒ¨æ”¹æˆã€Œå…¬å‘Šã€ï¼šåªé¡¯ç¤ºå…¬å‘Šæ¢ï¼Œä¸å†é¡¯ç¤ºä»»ä½•æ¸…å–®å€å¡Š
  if(ann){
    $("notice").style.display="block";
    $("notice").textContent=`ğŸ“£ å…¬å‘Š ${ann} ç­†ï¼ˆé»æ­¤å‰å¾€å» å•†é ï¼‰`;
  }else $("notice").style.display="none";
}

async function loadYear(){
  const y=$("year2").value;
  const map=new Map(); let any=0;
  for(let m=1;m<=12;m++){
    try{
      const r=await fetch(file(y,m),{cache:"no-store"}); if(!r.ok) continue;
      any++; const rows=await r.json();
      rows.forEach(x=>{
        const code=x["è—¥ä»£"], name=x["è—¥å“"], use=Number(x["æœˆç”¨é‡"]||0);
        const vRaw=(x["å» å•†"]||x["ä¾›æ‡‰å•†"]||x["è—¥å•†"]||"").trim();
        const vend=normVendor(vRaw)||normVendor(name)||"";
        const k=code;
        if(!map.has(k)) map.set(k,{è—¥ä»£:code,è—¥å“:name,å» å•†:vend,ç”¨é‡:0});
        map.get(k).ç”¨é‡+=use;
      });
    }catch{}
  }
  const arr=[...map.values()].sort((a,b)=>String(a.è—¥ä»£).localeCompare(String(b.è—¥ä»£)));
  $("yInfo").textContent=`æœ‰è³‡æ–™æœˆä»½ï¼š${any} / 12`;
  const tb=$("yTb"); tb.innerHTML="";
  arr.forEach(x=>{
    const u=usage(x), st=stock[x.è—¥ä»£], annF=isAnn(x);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${x.è—¥ä»£}</td><td>${x.è—¥å“}</td><td>${u}</td><td>${st??""}</td><td>${x.å» å•†||""}</td>`;
    tb.appendChild(tr);
  });
  setView("vYear");
}

function renderVendorPage(v, silent){
  if(!v){ if(!silent) setView("vVendor"); return; }
  const list=(lastFiltered.length?lastFiltered:data).filter(x=>x.å» å•†===normVendor(v) || x.å» å•†===v);
  const tb=$("vTb"); tb.innerHTML="";
  list.forEach(x=>{
    const u=usage(x), st=stock[x.è—¥ä»£], annF=isAnn(x);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${x.è—¥ä»£}</td><td>${x.è—¥å“}</td><td>${u}</td><td>${st??""}</td><td>${x.å» å•†||""}</td>`;
    tb.appendChild(tr);
  });
  if(!silent){ $("vendorPick").value=normVendor(v)||v; setView("vVendor"); }
}

function exportExcelLike(){
  // ä»¥ CSV åŒ¯å‡ºï¼ˆExcel å¯ç›´æ¥é–‹ï¼‰ï¼Œå…§å®¹ä»¥ã€Œç›®å‰ç•«é¢ç¯©é¸çµæœã€ç‚ºæº–
  const y=$("year").value, s=+$("m1").value, e=$("adv").checked?+$("m2").value:s;
  const a=Math.min(s,e), b=Math.max(s,e);
  const rows=(lastFiltered.length?lastFiltered:data);
  const head=["è—¥ä»£","è—¥å“","ç”¨é‡","åº«å­˜","å» å•†","å…¬å‘Š","å‚™è¨»"];
  const csv=[head.join(",")].concat(rows.map(x=>{
    const u=usage(x), st=stock[x.è—¥ä»£], ann=isAnn(x)?"æ˜¯":"";
    const note=(notes[x.è—¥ä»£]||"").replaceAll('"','""');
    return [x.è—¥ä»£,x.è—¥å“,u,(st??""),x.å» å•†,ann,`"${note}"`].join(",");
  })).join("\n");
  const bom="\uFEFF"; // é˜²ä¸­æ–‡äº‚ç¢¼
  const blob=new Blob([bom+csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const fn=`export_${y}_${String(a).padStart(2,"0")}${a===b?"":"-"+String(b).padStart(2,"0")}.csv`;
  const aTag=document.createElement("a"); aTag.href=url; aTag.download=fn; aTag.click();
  setTimeout(()=>URL.revokeObjectURL(url),500);
}

init();
})();
</script>
</body></html>
