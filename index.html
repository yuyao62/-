<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>藥品廠商統計 Web App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 讀取 Excel 用的 SheetJS（XLSX） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
    }
    .app {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    }
    h1 {
      margin-top: 0;
      font-size: 22px;
    }
    .section-title {
      font-weight: 600;
      margin: 16px 0 8px;
    }
    .uploader {
      border: 2px dashed #cbd5f5;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      background: #f9fafb;
    }
    input[type="file"] {
      margin-top: 8px;
    }
    .summary-table, .detail-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }
    .summary-table th, .summary-table td,
    .detail-table th, .detail-table td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
    }
    .summary-table th, .detail-table th {
      background: #f3f4f6;
    }
    .summary-row {
      cursor: pointer;
    }
    .summary-row:hover {
      background: #e5f0ff;
    }
    .highlight {
      background: #dbeafe !important;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      font-size: 12px;
      margin-left: 4px;
    }
    .info-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
    }
    .error {
      color: #b91c1c;
      font-size: 13px;
      margin-top: 6px;
    }
    .vendor-title {
      margin-top: 16px;
      font-weight: 600;
      font-size: 15px;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>藥品廠商統計 Web App</h1>
    <p class="info-text">
      上傳含有「藥品、廠商、累計數量/累計用量」欄位的 Excel 檔，
      系統會依「廠商前兩碼」統計總累計用量，並可點選查看各廠商的藥品清單。
    </p>

    <!-- 檔案上傳區 -->
    <div class="uploader">
      <div class="section-title">1️⃣ 上傳 Excel 檔</div>
      <input type="file" id="fileInput" accept=".xlsx,.xls" />
      <div id="fileInfo" class="info-text"></div>
      <div id="errorBox" class="error"></div>
    </div>

    <!-- 廠商代碼統計區 -->
    <div style="margin-top: 20px;">
      <div class="section-title">2️⃣ 廠商代碼統計 (點選可查看藥品)</div>
      <table class="summary-table" id="summaryTable">
        <thead>
          <tr>
            <th style="width: 80px;">編號</th>
            <th style="width: 120px;">廠商代碼</th>
            <th>總累計用量</th>
          </tr>
        </thead>
        <tbody id="summaryBody">
          <tr><td colspan="3">尚未載入資料</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 藥品明細區 -->
    <div style="margin-top: 20px;">
      <div class="section-title">3️⃣ 藥品清單</div>
      <div id="vendorTitle" class="vendor-title">尚未選擇廠商代碼</div>
      <table class="detail-table" id="detailTable">
        <thead>
          <tr>
            <th style="width: 60px;">序號</th>
            <th>藥品</th>
            <th style="width: 120px;">累計用量</th>
            <th style="width: 180px;">廠商</th>
          </tr>
        </thead>
        <tbody id="detailBody">
          <tr><td colspan="4">請先從上方表格點選一個廠商代碼</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const fileInfo = document.getElementById("fileInfo");
    const errorBox = document.getElementById("errorBox");
    const summaryBody = document.getElementById("summaryBody");
    const detailBody = document.getElementById("detailBody");
    const vendorTitle = document.getElementById("vendorTitle");

    let fullData = [];        // 原始每一列資料
    let summaryData = [];     // 廠商代碼 + 總累計用量

    fileInput.addEventListener("change", handleFile, false);

    function handleFile(event) {
      const file = event.target.files[0];
      errorBox.textContent = "";
      vendorTitle.textContent = "尚未選擇廠商代碼";
      detailBody.innerHTML = "<tr><td colspan='4'>請先從上方表格點選一個廠商代碼</td></tr>";

      if (!file) {
        fileInfo.textContent = "";
        summaryBody.innerHTML = "<tr><td colspan='3'>尚未載入資料</td></tr>";
        return;
      }

      fileInfo.textContent = `已選擇檔案：${file.name}`;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          // 盡量用 Sheet1；如果沒有，就用第一個 sheet
          const sheetName = workbook.Sheets["Sheet1"]
            ? "Sheet1"
            : workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];

          let json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

          if (!json.length) {
            throw new Error("工作表為空或欄位名稱無法辨識");
          }

          processData(json);
        } catch (err) {
          console.error(err);
          errorBox.textContent = "解析 Excel 發生錯誤：" + err.message;
          summaryBody.innerHTML = "<tr><td colspan='3'>載入失敗</td></tr>";
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processData(rows) {
      // 1. 欄位名稱處理 (trim + rename)
      const cleanedRows = rows.map((row) => {
        const newRow = {};
        for (const key in row) {
          const newKey = key.trim();
          newRow[newKey] = row[key];
        }

        // 處理「累計數量」→「累計用量」
        if ("累計數量" in newRow && !("累計用量" in newRow)) {
          newRow["累計用量"] = newRow["累計數量"];
        }

        // 確保有累計用量欄位
        if (!("累計用量" in newRow)) {
          newRow["累計用量"] = 0;
        }

        // 廠商空值處理
        let vendor = newRow["廠商"];
        if (vendor === undefined || vendor === null || String(vendor).trim() === "") {
          vendor = "未標示廠商";
        }
        vendor = String(vendor).trim();
        newRow["廠商"] = vendor;

        // 廠商代碼 = 前 2 碼
        newRow["廠商代碼"] = vendor.slice(0, 2);

        // 數字處理
        let amount = newRow["累計用量"];
        let num = parseFloat(String(amount).toString().replace(/,/g, ""));
        if (isNaN(num)) num = 0;
        newRow["累計用量"] = num;

        return newRow;
      });

      fullData = cleanedRows;

      // 2. 依廠商代碼 groupby 累計
      const summaryMap = new Map();
      for (const row of fullData) {
        const code = row["廠商代碼"] || "NA";
        const amt = row["累計用量"] || 0;
        if (!summaryMap.has(code)) {
          summaryMap.set(code, 0);
        }
        summaryMap.set(code, summaryMap.get(code) + amt);
      }

      summaryData = Array.from(summaryMap.entries())
        .map(([code, total]) => ({ 廠商代碼: code, 總累計用量: total }))
        // 可以改排序，現在是照總累計用量由大到小
        .sort((a, b) => b.總累計用量 - a.總累計用量);

      renderSummaryTable();
    }

    function renderSummaryTable() {
      if (!summaryData.length) {
        summaryBody.innerHTML = "<tr><td colspan='3'>沒有資料</td></tr>";
        return;
      }

      summaryBody.innerHTML = "";
      summaryData.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.className = "summary-row";
        tr.dataset.vendorCode = row["廠商代碼"];

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${row["廠商代碼"]}</td>
          <td>${row["總累計用量"].toFixed(1)}</td>
        `;

        tr.addEventListener("click", () => {
          // 取消其他 highlight
          document
            .querySelectorAll(".summary-row")
            .forEach((el) => el.classList.remove("highlight"));
          tr.classList.add("highlight");
          showVendorDetail(row["廠商代碼"]);
        });

        summaryBody.appendChild(tr);
      });
    }

    function showVendorDetail(vendorCode) {
      const rows = fullData.filter((row) => row["廠商代碼"] === vendorCode);

      vendorTitle.textContent = `廠商代碼「${vendorCode}」的藥品清單（共 ${rows.length} 筆）`;

      if (!rows.length) {
        detailBody.innerHTML =
          "<tr><td colspan='4'>此廠商代碼沒有對應藥品資料</td></tr>";
        return;
      }

      detailBody.innerHTML = "";
      rows.forEach((row, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${String(row["藥品"] || "").slice(0, 80)}</td>
          <td>${row["累計用量"].toFixed(1)}</td>
          <td>${row["廠商"]}</td>
        `;
        detailBody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
